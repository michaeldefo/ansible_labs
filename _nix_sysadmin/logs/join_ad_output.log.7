ansible-playbook [core 2.14.18]
  config file = /opt/_nix_sysadmin/ansible.cfg
  configured module search path = ['/home/ansible/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.9/site-packages/ansible
  ansible collection location = /home/ansible/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/bin/ansible-playbook
  python version = 3.9.21 (main, Jun 27 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-5)] (/usr/bin/python3)
  jinja version = 3.1.2
  libyaml = True
Using /opt/_nix_sysadmin/ansible.cfg as config file
Skipping callback 'default', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: join_ad.yml **********************************************************
1 plays in playbooks/join_ad.yml

PLAY [Join Linux host to Active Directory] *************************************

TASK [Gathering Facts] *********************************************************
task path: /opt/_nix_sysadmin/playbooks/join_ad.yml:10
ok: [srv-obs-lnx]

TASK [join_ad_linux : Installer les paquets requis (RHEL)] *********************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:11
skipping: [srv-obs-lnx] => {"changed": false, "skip_reason": "Conditional result was False"}

TASK [join_ad_linux : Installer les paquets requis (Debian)] *******************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:27
changed: [srv-obs-lnx] => {"cache_update_time": 1750888373, "cache_updated": false, "changed": true, "stderr": "", "stderr_lines": [], "stdout": "Reading package lists...\nBuilding dependency tree...\nReading state information...\nThe following additional packages will be installed:\n  python3-ptyprocess\nSuggested packages:\n  python-pexpect-doc\nThe following NEW packages will be installed:\n  python3-pexpect python3-ptyprocess\n0 upgraded, 2 newly installed, 0 to remove and 12 not upgraded.\nNeed to get 67.6 kB of archives.\nAfter this operation, 270 kB of additional disk space will be used.\nGet:1 http://deb.debian.org/debian bookworm/main amd64 python3-ptyprocess all 0.7.0-5 [14.7 kB]\nGet:2 http://deb.debian.org/debian bookworm/main amd64 python3-pexpect all 4.8.0-4 [52.9 kB]\nFetched 67.6 kB in 0s (251 kB/s)\nSelecting previously unselected package python3-ptyprocess.\r\n(Reading database ... \r(Reading database ... 5%\r(Reading database ... 10%\r(Reading database ... 15%\r(Reading database ... 20%\r(Reading database ... 25%\r(Reading database ... 30%\r(Reading database ... 35%\r(Reading database ... 40%\r(Reading database ... 45%\r(Reading database ... 50%\r(Reading database ... 55%\r(Reading database ... 60%\r(Reading database ... 65%\r(Reading database ... 70%\r(Reading database ... 75%\r(Reading database ... 80%\r(Reading database ... 85%\r(Reading database ... 90%\r(Reading database ... 95%\r(Reading database ... 100%\r(Reading database ... 40993 files and directories currently installed.)\r\nPreparing to unpack .../python3-ptyprocess_0.7.0-5_all.deb ...\r\nUnpacking python3-ptyprocess (0.7.0-5) ...\r\nSelecting previously unselected package python3-pexpect.\r\nPreparing to unpack .../python3-pexpect_4.8.0-4_all.deb ...\r\nUnpacking python3-pexpect (4.8.0-4) ...\r\nSetting up python3-ptyprocess (0.7.0-5) ...\r\nSetting up python3-pexpect (4.8.0-4) ...\r\n", "stdout_lines": ["Reading package lists...", "Building dependency tree...", "Reading state information...", "The following additional packages will be installed:", "  python3-ptyprocess", "Suggested packages:", "  python-pexpect-doc", "The following NEW packages will be installed:", "  python3-pexpect python3-ptyprocess", "0 upgraded, 2 newly installed, 0 to remove and 12 not upgraded.", "Need to get 67.6 kB of archives.", "After this operation, 270 kB of additional disk space will be used.", "Get:1 http://deb.debian.org/debian bookworm/main amd64 python3-ptyprocess all 0.7.0-5 [14.7 kB]", "Get:2 http://deb.debian.org/debian bookworm/main amd64 python3-pexpect all 4.8.0-4 [52.9 kB]", "Fetched 67.6 kB in 0s (251 kB/s)", "Selecting previously unselected package python3-ptyprocess.", "(Reading database ... ", "(Reading database ... 5%", "(Reading database ... 10%", "(Reading database ... 15%", "(Reading database ... 20%", "(Reading database ... 25%", "(Reading database ... 30%", "(Reading database ... 35%", "(Reading database ... 40%", "(Reading database ... 45%", "(Reading database ... 50%", "(Reading database ... 55%", "(Reading database ... 60%", "(Reading database ... 65%", "(Reading database ... 70%", "(Reading database ... 75%", "(Reading database ... 80%", "(Reading database ... 85%", "(Reading database ... 90%", "(Reading database ... 95%", "(Reading database ... 100%", "(Reading database ... 40993 files and directories currently installed.)", "Preparing to unpack .../python3-ptyprocess_0.7.0-5_all.deb ...", "Unpacking python3-ptyprocess (0.7.0-5) ...", "Selecting previously unselected package python3-pexpect.", "Preparing to unpack .../python3-pexpect_4.8.0-4_all.deb ...", "Unpacking python3-pexpect (4.8.0-4) ...", "Setting up python3-ptyprocess (0.7.0-5) ...", "Setting up python3-pexpect (4.8.0-4) ..."]}

TASK [join_ad_linux : Configurer le DNS] ***************************************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:45
ok: [srv-obs-lnx] => {"backup": "", "changed": false, "msg": ""}

TASK [join_ad_linux : Ajouter le domaine au fichier /etc/hosts] ****************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:53
ok: [srv-obs-lnx] => {"backup": "", "changed": false, "msg": ""}

TASK [join_ad_linux : Découverte du domaine] ***********************************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:59
ok: [srv-obs-lnx] => {"changed": false, "cmd": ["realm", "discover", "lab.local"], "delta": "0:00:00.063704", "end": "2025-07-14 22:52:02.636337", "msg": "", "rc": 0, "start": "2025-07-14 22:52:02.572633", "stderr": "", "stderr_lines": [], "stdout": "lab.local\n  type: kerberos\n  realm-name: LAB.LOCAL\n  domain-name: lab.local\n  configured: no\n  server-software: active-directory\n  client-software: sssd\n  required-package: sssd-tools\n  required-package: sssd\n  required-package: libnss-sss\n  required-package: libpam-sss\n  required-package: adcli\n  required-package: samba-common-bin", "stdout_lines": ["lab.local", "  type: kerberos", "  realm-name: LAB.LOCAL", "  domain-name: lab.local", "  configured: no", "  server-software: active-directory", "  client-software: sssd", "  required-package: sssd-tools", "  required-package: sssd", "  required-package: libnss-sss", "  required-package: libpam-sss", "  required-package: adcli", "  required-package: samba-common-bin"]}

TASK [join_ad_linux : Configurer Kerberos] *************************************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:65
ok: [srv-obs-lnx] => {"changed": false, "checksum": "7100ea708c96023ae7bc200918abc8697685f5be", "dest": "/etc/krb5.conf", "gid": 0, "group": "root", "mode": "0644", "owner": "root", "path": "/etc/krb5.conf", "size": 593, "state": "file", "uid": 0}

TASK [join_ad_linux : Redémarrer le service SSSD] ******************************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:74
changed: [srv-obs-lnx] => {"changed": true, "enabled": true, "name": "sssd", "state": "started", "status": {"ActiveEnterTimestampMonotonic": "0", "ActiveExitTimestampMonotonic": "0", "ActiveState": "inactive", "After": "sysinit.target system.slice systemd-journald.socket basic.target", "AllowIsolate": "no", "AssertResult": "no", "AssertTimestampMonotonic": "0", "Before": "sssd-nss.service sssd-pac.socket sssd-nss.socket sssd-sudo.socket sssd-ssh.service sssd-pac.service nss-user-lookup.target sssd-autofs.socket sssd-pam.socket multi-user.target sssd-autofs.service sssd-pam-priv.socket sssd-sudo.service shutdown.target sssd-ssh.socket sssd-pam.service systemd-user-sessions.service", "BlockIOAccounting": "no", "BlockIOWeight": "[not set]", "BoundBy": "sssd-pam.socket sssd-autofs.service sssd-nss.service sssd-sudo.socket sssd-autofs.socket sssd-nss.socket sssd-ssh.service sssd-pac.service sssd-ssh.socket sssd-pam-priv.socket sssd-pac.socket sssd-pam.service sssd-sudo.service", "CPUAccounting": "yes", "CPUAffinityFromNUMA": "no", "CPUQuotaPerSecUSec": "infinity", "CPUQuotaPeriodUSec": "infinity", "CPUSchedulingPolicy": "0", "CPUSchedulingPriority": "0", "CPUSchedulingResetOnFork": "no", "CPUShares": "[not set]", "CPUUsageNSec": "[not set]", "CPUWeight": "[not set]", "CacheDirectoryMode": "0755", "CanFreeze": "yes", "CanIsolate": "no", "CanReload": "no", "CanStart": "yes", "CanStop": "yes", "CapabilityBoundingSet": "cap_chown cap_dac_read_search cap_fowner cap_kill cap_setgid cap_setuid cap_net_admin cap_ipc_lock cap_sys_admin cap_sys_nice cap_sys_resource cap_block_suspend", "CleanResult": "success", "CollectMode": "inactive", "ConditionResult": "no", "ConditionTimestamp": "Mon 2025-07-14 22:27:20 CEST", "ConditionTimestampMonotonic": "11842983159", "ConfigurationDirectoryMode": "0755", "Conflicts": "shutdown.target", "ControlGroupId": "0", "ControlPID": "0", "CoredumpFilter": "0x33", "DefaultDependencies": "yes", "DefaultMemoryLow": "0", "DefaultMemoryMin": "0", "Delegate": "no", "Description": "System Security Services Daemon", "DevicePolicy": "auto", "DynamicUser": "no", "Environment": "DEBUG_LOGGER=--logger=files", "EnvironmentFiles": "/etc/default/sssd (ignore_errors=yes)", "ExecMainCode": "0", "ExecMainExitTimestampMonotonic": "0", "ExecMainPID": "0", "ExecMainStartTimestampMonotonic": "0", "ExecMainStatus": "0", "ExecStart": "{ path=/usr/sbin/sssd ; argv[]=/usr/sbin/sssd -i ${DEBUG_LOGGER} ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }", "ExecStartEx": "{ path=/usr/sbin/sssd ; argv[]=/usr/sbin/sssd -i ${DEBUG_LOGGER} ; flags= ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }", "ExitType": "main", "FailureAction": "none", "FileDescriptorStoreMax": "0", "FinalKillSignal": "9", "FragmentPath": "/lib/systemd/system/sssd.service", "FreezerState": "running", "GID": "[not set]", "GuessMainPID": "yes", "IOAccounting": "no", "IOReadBytes": "18446744073709551615", "IOReadOperations": "18446744073709551615", "IOSchedulingClass": "2", "IOSchedulingPriority": "4", "IOWeight": "[not set]", "IOWriteBytes": "18446744073709551615", "IOWriteOperations": "18446744073709551615", "IPAccounting": "no", "IPEgressBytes": "[no data]", "IPEgressPackets": "[no data]", "IPIngressBytes": "[no data]", "IPIngressPackets": "[no data]", "Id": "sssd.service", "IgnoreOnIsolate": "no", "IgnoreSIGPIPE": "yes", "InactiveEnterTimestampMonotonic": "0", "InactiveExitTimestampMonotonic": "0", "JobRunningTimeoutUSec": "infinity", "JobTimeoutAction": "none", "JobTimeoutUSec": "infinity", "KeyringMode": "private", "KillMode": "control-group", "KillSignal": "15", "LimitAS": "infinity", "LimitASSoft": "infinity", "LimitCORE": "infinity", "LimitCORESoft": "0", "LimitCPU": "infinity", "LimitCPUSoft": "infinity", "LimitDATA": "infinity", "LimitDATASoft": "infinity", "LimitFSIZE": "infinity", "LimitFSIZESoft": "infinity", "LimitLOCKS": "infinity", "LimitLOCKSSoft": "infinity", "LimitMEMLOCK": "8388608", "LimitMEMLOCKSoft": "8388608", "LimitMSGQUEUE": "819200", "LimitMSGQUEUESoft": "819200", "LimitNICE": "0", "LimitNICESoft": "0", "LimitNOFILE": "524288", "LimitNOFILESoft": "1024", "LimitNPROC": "7709", "LimitNPROCSoft": "7709", "LimitRSS": "infinity", "LimitRSSSoft": "infinity", "LimitRTPRIO": "0", "LimitRTPRIOSoft": "0", "LimitRTTIME": "infinity", "LimitRTTIMESoft": "infinity", "LimitSIGPENDING": "7709", "LimitSIGPENDINGSoft": "7709", "LimitSTACK": "infinity", "LimitSTACKSoft": "8388608", "LoadState": "loaded", "LockPersonality": "no", "LogLevelMax": "-1", "LogRateLimitBurst": "0", "LogRateLimitIntervalUSec": "0", "LogsDirectoryMode": "0755", "MainPID": "0", "ManagedOOMMemoryPressure": "auto", "ManagedOOMMemoryPressureLimit": "0", "ManagedOOMPreference": "none", "ManagedOOMSwap": "auto", "MemoryAccounting": "yes", "MemoryAvailable": "infinity", "MemoryCurrent": "[not set]", "MemoryDenyWriteExecute": "no", "MemoryHigh": "infinity", "MemoryLimit": "infinity", "MemoryLow": "0", "MemoryMax": "infinity", "MemoryMin": "0", "MemorySwapMax": "infinity", "MountAPIVFS": "no", "NFileDescriptorStore": "0", "NRestarts": "0", "NUMAPolicy": "n/a", "Names": "sssd.service", "NeedDaemonReload": "no", "Nice": "0", "NoNewPrivileges": "no", "NonBlocking": "no", "NotifyAccess": "main", "OOMPolicy": "stop", "OOMScoreAdjust": "0", "OnFailureJobMode": "replace", "OnSuccessJobMode": "fail", "PIDFile": "/run/sssd.pid", "Perpetual": "no", "PrivateDevices": "no", "PrivateIPC": "no", "PrivateMounts": "no", "PrivateNetwork": "no", "PrivateTmp": "no", "PrivateUsers": "no", "ProcSubset": "all", "ProtectClock": "no", "ProtectControlGroups": "no", "ProtectHome": "no", "ProtectHostname": "no", "ProtectKernelLogs": "no", "ProtectKernelModules": "no", "ProtectKernelTunables": "no", "ProtectProc": "default", "ProtectSystem": "no", "RefuseManualStart": "no", "RefuseManualStop": "no", "ReloadResult": "success", "RemainAfterExit": "no", "RemoveIPC": "no", "Requires": "system.slice sysinit.target", "Restart": "on-abnormal", "RestartKillSignal": "15", "RestartUSec": "100ms", "RestrictNamespaces": "no", "RestrictRealtime": "no", "RestrictSUIDSGID": "no", "Result": "success", "RootDirectoryStartOnly": "no", "RuntimeDirectoryMode": "0755", "RuntimeDirectoryPreserve": "no", "RuntimeMaxUSec": "infinity", "RuntimeRandomizedExtraUSec": "0", "SameProcessGroup": "no", "SecureBits": "0", "SendSIGHUP": "no", "SendSIGKILL": "yes", "Slice": "system.slice", "StandardError": "inherit", "StandardInput": "null", "StandardOutput": "journal", "StartLimitAction": "none", "StartLimitBurst": "5", "StartLimitIntervalUSec": "50s", "StartupBlockIOWeight": "[not set]", "StartupCPUShares": "[not set]", "StartupCPUWeight": "[not set]", "StartupIOWeight": "[not set]", "StateChangeTimestamp": "Mon 2025-07-14 22:26:59 CEST", "StateChangeTimestampMonotonic": "11822254650", "StateDirectoryMode": "0755", "StatusErrno": "0", "StopWhenUnneeded": "no", "SubState": "dead", "SuccessAction": "none", "SyslogFacility": "3", "SyslogLevel": "6", "SyslogLevelPrefix": "yes", "SyslogPriority": "30", "SystemCallErrorNumber": "2147483646", "TTYReset": "no", "TTYVHangup": "no", "TTYVTDisallocate": "no", "TasksAccounting": "yes", "TasksCurrent": "[not set]", "TasksMax": "2312", "TimeoutAbortUSec": "1min 30s", "TimeoutCleanUSec": "infinity", "TimeoutStartFailureMode": "terminate", "TimeoutStartUSec": "1min 30s", "TimeoutStopFailureMode": "terminate", "TimeoutStopUSec": "1min 30s", "TimerSlackNSec": "50000", "Transient": "no", "Type": "notify", "UID": "[not set]", "UMask": "0022", "UnitFilePreset": "enabled", "UnitFileState": "enabled", "UtmpMode": "init", "WantedBy": "multi-user.target", "Wants": "sssd-autofs.socket sssd-pam-priv.socket sssd-nss.socket nss-user-lookup.target sssd-ssh.socket sssd-pac.socket sssd-pam.socket sssd-sudo.socket", "WatchdogSignal": "6", "WatchdogTimestampMonotonic": "0", "WatchdogUSec": "infinity"}}

TASK [join_ad_linux : Joindre le domaine Active Directory] *********************
task path: /opt/_nix_sysadmin/roles/join_ad_linux/tasks/main.yml:81
fatal: [srv-obs-lnx]: FAILED! => {"changed": true, "cmd": "realm join --user=administrateur lab.local", "delta": "0:00:00.190674", "end": "2025-07-14 22:52:05.565139", "msg": "non-zero return code", "rc": 1, "start": "2025-07-14 22:52:05.374465", "stdout": "Password for administrateur: \r\nSee: journalctl REALMD_OPERATION=r12442.4627\r\nrealm: Couldn't join realm: Necessary packages are not installed: sssd-tools sssd libnss-sss libpam-sss adcli", "stdout_lines": ["Password for administrateur: ", "See: journalctl REALMD_OPERATION=r12442.4627", "realm: Couldn't join realm: Necessary packages are not installed: sssd-tools sssd libnss-sss libpam-sss adcli"]}

PLAY RECAP *********************************************************************
srv-obs-lnx                : ok=7    changed=2    unreachable=0    failed=1    skipped=1    rescued=0    ignored=0   

